---
title: "Lake Turkana Isotope Hydrology: New measurements, evaporation model, and mass balance"
date: 2022-01-04
output: 
  html_document: 
    highlight: monochrome
  html_notebook: 
    highlight: monochrome
editor_options: 
  chunk_output_type: inline
reference-section-title: "References"
---

```{r, setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(here, knitr, tidyverse, readxl, lubridate, ggthemes, kableExtra)
```

# Water isotope measurements

## Data visualization

### Define plot styles 

Colorblind-friendly palette from @tol2018.

```{r plot-styles, echo = FALSE}
theme_set(theme_tufte(base_family = "Helvetica") +
            theme(
              panel.background = element_rect(fill = 'white'), 
              panel.border = element_rect(fill=NA, color = "black", size = 0.5),
              panel.grid = element_line(color = "gray90", size = 0.5),
              plot.background = element_rect(fill='transparent', color = NA), 
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 14),
              legend.title = element_text(size = 14, face = "bold"),
              legend.text = element_text(size = 14),
              legend.background = element_rect(fill = 'transparent', color = NA), 
              legend.box.background = element_rect(fill = 'transparent', color = NA), 
              legend.position = "right"
            ))

# *To do*: Revisit appropriate axis limits for final plots
# axis.x.max <- max(waters$d18O) + 0.5
# axis.x.min <- min(waters$d18O) - 0.5
# axis.y.max <- max(waters$dD) + 0.5
# axis.y.min <- min(waters$dD) - 0.5

axis.x.label <- expression(paste(delta^{18}, "O (‰ VSMOW)"))
axis.y.label <- expression(paste(delta, "D (‰ VSMOW)"))

color.lake <- "#228833"
color.precip <- "#66CCEE"
color.river <- "#4477AA"
color.ground <- "#EE6677"
color.surface <- "#CCBB44"
color.GMWL <- "gray19"
color.model <- "gray69"

shape.lake <- 16 # circle
shape.precip <- 17 # triangle
shape.river <- 15 # square
shape.ground <- 7 # x in box
shape.surface <- 5 # diamond empty
shape.surface.lake <- 1 # circle empty
shape.model <- 3 # cross 

size.st <- 3
size.sm <- 1
size.lg <- 5
```

### Load and process data (this study)

```{r read-newdata, message = FALSE}
waters.rawdata <- read_csv(here("data/2016-2021_waters.csv"))

# Simplify WaterType categories
waters <- waters.rawdata |>
  mutate(WaterType = str_replace_all(WaterType, 
                                     c("River Delta" = "River",
                                       "Deep Ground" = "Ground",
                                       "Shallow Ground" = "Ground",
                                       "Spring" = "Ground",
                                       "Evaporated Surface" = "Surface")))
```

### New measurements

```{r plot-newdata, echo = FALSE}
# Highlight 2021 data using lower alpha for older samples 
plot.waters.2021 <- ggplot() +
  
  geom_point(data = waters |>
               filter(Date > "2021-01-01"),
             aes(x = d18O, y = dD, color = WaterType, shape = WaterType), size = size.st) +
  geom_point(data = waters |>
               filter(Date < "2021-01-01"),
             aes(x = d18O, y = dD, color = WaterType, shape = WaterType), size = size.st, alpha = 0.4) +
  geom_abline(data = NULL, aes(slope = 8, intercept = 10, color = "GMWL")) +
  
  labs(x = axis.x.label, 
       y = axis.y.label,
       caption = "Data from 2021 field season is darker; 2016-2020 data is lighter") +
  
    # legend
  scale_shape_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Ground", "GMWL"), 
    # set plot element shapes
    values = c(
      "Lake" = shape.lake,
      "Restricted Lake" = shape.surface.lake,
      "River" = shape.river,
      "Precipitation" = shape.precip,
      "Surface" = shape.surface,
      "Ground" = shape.ground,
      "GMWL" = 1)) +
  
  scale_color_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Ground", "GMWL"), 
    # set plot element colors
    values = c(
      "Lake" = color.lake,
      "Restricted Lake" = color.lake,
      "River" = color.river,
      "Precipitation" = color.precip,
      "Surface" = color.surface,
      "Ground" = color.ground,
      "GMWL" = color.GMWL)) +
  
  guides(color = guide_legend(override.aes=list(
    linetype = c(rep("blank", 6), "solid"),
    shape = c(shape.lake, shape.surface.lake, shape.river, shape.precip, shape.surface, shape.ground, NA),
    size = 2))) 

plot(plot.waters.2021)
```

### Load and process published data (Levin et al 2009)

This data set (@levin2009) includes measurements from the Ethiopian plateau, and other points outside of Turkana.  

```{r read-Levin, message = FALSE}
waters.Levin.rawdata <- read_excel(here("data/Levin_et_al_2009_raw_data.xls"))

# Make WaterType categories consistent with this study
waters.Levin <- waters.Levin.rawdata |>
  mutate(WaterType = str_replace_all(Type, 
                                     c("spring" = "Ground",
                                       "bore hole" = "Ground",
                                       "river" = "River",
                                       "water hole" = "Ground",
                                       "tap" = "Ground",
                                       "stream" = "Surface",
                                       "well" = "Ground",
                                       "rain" = "Precipitation")))
```

### Published measurements

```{r plot-inclusive, echo = FALSE, warning = FALSE}
# Compare with Levin et al 2009 shown in gray
plot.waters.inclusive <- ggplot() +
  
  geom_point(data = waters.Levin,
             aes(x = d18O_VSMOW, y = dD_VSMOW, shape = WaterType), size = size.st, color = "gray77", 
             show.legend = FALSE) +
  geom_point(data = waters,
             aes(x = d18O, y = dD, color = WaterType, shape = WaterType), size = size.st) +
  geom_abline(data = NULL, aes(slope = 8, intercept = 10, color = "GMWL")) +
  
  labs(x = axis.x.label, 
       y = axis.y.label,
       caption = "Data from Levin et al 2009 shown in gray") +
  
    # legend
  scale_shape_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Ground", "GMWL"), 
    # set plot element shapes
    values = c(
      "Lake" = shape.lake,
      "Restricted Lake" = shape.surface.lake,
      "River" = shape.river,
      "Precipitation" = shape.precip,
      "Surface" = shape.surface,
      "Ground" = shape.ground,
      "GMWL" = 1)) +
  
  scale_color_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Ground", "GMWL"), 
    # set plot element colors
    values = c(
      "Lake" = color.lake,
      "Restricted Lake" = color.lake,
      "River" = color.river,
      "Precipitation" = color.precip,
      "Surface" = color.surface,
      "Ground" = color.ground,
      "GMWL" = color.GMWL)) +
  
  guides(color = guide_legend(override.aes=list(
    linetype = c(rep("blank", 6), "solid"),
    shape = c(shape.lake, shape.surface.lake, shape.river, shape.precip, shape.surface, shape.ground, NA),
    size = 2))) 

plot(plot.waters.inclusive)
```

## Summary values

```{r summary-data, echo = FALSE}
waters.summary <- waters |>
  group_by(WaterType) |>
  summarize(d18O_mean = mean(d18O),
            d18O_stdv = sd(d18O),
            dD_mean = mean(dD),
            dD_stdv = sd(dD)) |>
  mutate(Source = "this study")

waters.summary.Levin <- waters.Levin |>
  group_by(WaterType) |>
  summarize(d18O_mean = mean(d18O_VSMOW, na.rm = TRUE),
            d18O_stdv = sd(d18O_VSMOW, na.rm = TRUE),
            dD_mean = mean(dD_VSMOW, na.rm = TRUE),
            dD_stdv = sd(dD_VSMOW, na.rm = TRUE)) |>
  mutate(Source = "Levin et al 2009")

Omo.River <- waters.Levin |>
  filter(grepl("Omo River", Sampling_Location_and_Notes)) |>
  # group_by(Sampling_Location_and_Notes) |>
  # summarize(d18O_mean = mean(d18O_VSMOW, na.rm = TRUE),
  #           d18O_stdv = sd(d18O_VSMOW, na.rm = TRUE),
  #           dD_mean = mean(dD_VSMOW, na.rm = TRUE),
  #           dD_stdv = sd(dD_VSMOW, na.rm = TRUE)) |>
  mutate(Source = "Levin et al 2009")

mean.surface.TC <- mean(waters$SurfaceTempC, na.rm = TRUE)
mean.rh <- 0.33 # From TBI-Ileret PurpleAir sensor lifetime average

waters.summary <- rbind(waters.summary, waters.summary.Levin) |>
  mutate(d18O_mean = round(d18O_mean, 2),
         d18O_stdv = round(d18O_stdv, 2),
         dD_mean = round(dD_mean, 2),
         dD_stdv = round(dD_stdv, 2)) 

waters.summary |>
  arrange(WaterType) |>
  kbl() |>
  kable_styling()

```

# Local evaporation line model

## Define model function

The function produces a plot-able data frame of δ^18^O and δD values representing isotope composition of evaporate water given isotope values of input water and atmospheric conditions. Formulas and relationships are defined in @gibson2016 and @horita1994.

```{r define-model}
model.LEL <- function(env.input){
  
  # Celsius to Kelvin conversion
  TK <- env.input["TC"] + 273.15
  
  # liquid-vapor fractionation factors (Horita & Wesolowski 1994)
  aD <- exp( ((1158.8 * TK^3)/1e12) - ((1620.1 * TK^2)/1e9) + ((794.84 * TK)/1e6) - (161.04/1e3)  + (2.992e6/TK^3) )
  a18O <- exp( (-7.685e-3) + (6.7123 / TK) - (1.6664e3 / TK^2) + (0.35041e6 / TK^3) )
  
  # equilibrium isotopic separation (ibid.)
  eD <- (aD - 1) * 1000
  e18O <- (a18O - 1) * 1000
  
  # diffusion controlled fractionation (ibid.)
  ekD <- 12.5 * (1 - env.input["rh"])
  ek18O <- 14.2 * (1 - env.input["rh"])
  
  # atmospheric isotope ratios (Gibson et al 2016 eqn 18) 
  dDA <- (env.input["dDp"] - (env.input["k"] * eD)) / 
    (1 + (1e-3 * env.input["k"] * eD))
  d18OA <- (env.input["d18Op"] - (env.input["k"] * e18O)) / 
    (1 + (1e-3 * env.input["k"] * e18O))
  
  # limiting isotope ratios (Gibson et al 2016 eqn 7)
  dstarD <- ((env.input["rh"] * dDA) + ekD + (eD / aD)) / 
    (env.input["rh"] - (1e-3 * (ekD + (eD / aD))))
  dstar18O <- ((env.input["rh"] * d18OA) + ek18O + (e18O / a18O)) / 
    (env.input["rh"] - (1e-3 * (ek18O + (e18O / a18O))))
  
  # temporal enrichment slope (Gibson et al 2016 eqn 6)
  mD <- (env.input["rh"] - (1e-3 * (ekD + (eD / aD)))) /
    ((1 - env.input["rh"]) + (1e-3 * ekD))
  m18O <- (env.input["rh"] - (1e-3 * (ek18O + (e18O / a18O)))) / 
    ((1 - env.input["rh"]) + (1e-3 * ek18O))
  
  # create values for evaporation to inflow ratio (x = E / I) from 0 (no evaporation, lake growing) to 1 (fully evaporated lake)
  # adjust "by" param up or down to have fewer or more points on the model line
  x <- seq(from = 0, to = 1, by = 0.07) 
  
  # lake water isotopes for values of x (Gibson et al 2016 eqn 10) and vapor isotopes (eqn 3)
  dDL <- (env.input["dDi"]  + (mD * x * dstarD)) / (1 + mD * x)
  d18OL <- (env.input["d18Oi"] + (m18O * x * dstar18O)) / (1 + m18O * x)
  dDv <- (((dDL - eD) / aD) - (env.input["rh"] * dDA) - ekD) / (1 - env.input["rh"] + (1e-3 * ekD))
  d18Ov <- (((d18OL - e18O) / a18O) - (env.input["rh"] * d18OA) - ek18O) / (1 - env.input["rh"] + (1e-3 * ek18O))
  
  # combine modeled lake and vapor delta values in data frame for plotting
  dL <- as.data.frame(cbind("d18O" = d18OL, "dD" = dDL))
  dv <- as.data.frame(cbind("d18O" = d18Ov, "dD" = dDv))
  model.line <- as.data.frame(rbind(dL, dv))
  
  return(model.line)
}
```

## Model inputs

Build model evaporation lines using environmental conditions, starting with a single scenario.

```{r model-inputs-single}
env.conditions <- c(
  
  # average air temperature (C); evaporation model is most accurate given an air-water interface temperature 
  "TC" = 28,
  
  # average humidity (%rh); evaporation model is most accurate given a value normalized to water surface temperature
  "rh" = 0.25,
  
  # d18O & dD (permil VSMOW) for lake water input 
  "d18Oi" = -0.4,
  "dDi"   = 9,
  
  # d18O & dD (permil VSMOW) for precipitation
  "d18Op" = 0.9,
  "dDp"   = 10,
  
  # degree to which there is isotopic equilibrium between precipitation and atmospheric water vapor
  "k" = 0.1
)

result.LEL <- model.LEL(env.conditions)
```

### Create model scenarios

Apply the model over a range of scenarios, varying different inputs. 
*How do we use co-varying d18O & dD values that make sense together?*

```{r model-inputs-vary}
# Produce lists of incremental values 
# length of 6 provides 6 rows for a table of inputs, 6 plots for a panel
seq.length <- 6

vary.TC <- seq(from = 20, to = 40, length.out = seq.length)
vary.rh <- seq(from = 0.1, to = 0.6, length.out = seq.length)
vary.d18Oi <- seq(from = -3.5, to = 1.5, length.out = seq.length)
vary.dDi <- seq(from = -30, to = 20, length.out = seq.length)
vary.d18Op <- seq(from = -3, to = 6, length.out = seq.length)
vary.dDp <- seq(from = -30, to = 40, length.out = seq.length)
vary.k <- seq(from = 0, to = 1, length.out = seq.length)

```

### Model with meteoric waters

Single plot, LEL for environmental conditions: `r paste(names(env.conditions), "=", env.conditions, collapse=", ")`

```{r LEL-meteoric}
# Filter meteoric waters (all types except ground)
waters.meteoric <- waters |>
  filter(WaterType != "Ground")

plot.LEL <- ggplot(data = result.LEL, aes(x = d18O, y = dD, color = "Modeled LEL")) +
  
  # plot elements
  geom_point(shape = shape.model) + geom_line() +
  geom_point(data = waters.meteoric,
             aes(x = d18O, y = dD, color = WaterType, shape = WaterType), size = size.st, show.legend = FALSE) +
  geom_abline(data = NULL, aes(slope = 8, intercept = 10, color = "GMWL"), show.legend = FALSE) +
  
  # legend
  scale_shape_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Modeled LEL", "GMWL"), 
    # set plot element shapes
    values = c(
      "Lake" = shape.lake,
      "Restricted Lake" = shape.surface.lake,
      "River" = shape.river,
      "Precipitation" = shape.precip,
      "Surface" = shape.surface,
      "Modeled LEL" = shape.model,
      "GMWL" = 1)) +
  
  scale_color_manual(
    breaks = c("Lake", "Restricted Lake", "River", "Precipitation", "Surface", "Modeled LEL", "GMWL"), 
    # set plot element colors
    values = c(
      "Lake" = color.lake,
      "Restricted Lake" = color.lake,
      "River" = color.river,
      "Precipitation" = color.precip,
      "Surface" = color.surface,
      "Modeled LEL" = color.model,
      "GMWL" = color.GMWL)) +
  
  guides(color = guide_legend(override.aes=list(
    linetype = c(rep("blank", 5), rep("solid", 2)),
    shape = c(shape.lake, shape.surface.lake, shape.river, shape.precip, shape.surface, shape.model, NA),
    size = 2))) +
  
  labs(x = axis.x.label, 
       y = axis.y.label,
       caption = paste(names(env.conditions), "=", env.conditions, collapse = ", "))

plot(plot.LEL)
```

*To do:* Generate a 4 or 6 panel figure with four sets of input values. Use `apply()` for this? 

## Test models

*To do:* Get statistical comparison (ANOVA? T-test?) between each model LEL and the lake waters

### De-trend lake data

*To do:* Subtract LEL model from lake data to check for fit

Like this?

-   Get linear equation for LEL

-   Apply linear function to lake δ^18^O values to produce data frame of real δ^18^O vs modeled δD

-   Use `detrend()` to remove linear trend from new data frame


## Mass balance

Estimate lake volumes from [USDA Foreign Agriculture Service](https://ipad.fas.usda.gov/cropexplorer/global_reservoir/gr_regional_chart.aspx?regionid=eafrica&reservoir_name=Turkana&lakeid=000093) and estimate percent increases in inputs needed.